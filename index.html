<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tic-Tac-Toe</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Tilt+Warp&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />

    <style>
      body {
        font-family: "Tilt Warp", sans-serif;
        text-align: center;
        background: #f9fafb;
      }

      #cont {
        display: grid;
        grid-template-columns: repeat(3, 100px);
        grid-gap: 10px;
        justify-content: center;
        margin-top: 20px;
      }

      .btn {
        height: 100px;
        width: 100px;
        font-size: 2rem;
        cursor: pointer;
        border-radius: 10px;
        border: 2px solid #333;
        background-color: #fff;
        transition: 0.2s ease;
      }

      .btn:disabled {
        cursor: not-allowed;
        background-color: #eee;
      }

      #loading {
        width: 80px;
        display: block;
        margin: 20px auto;
      }
    </style>
  </head>

  <body>
    <h1>Tic-Tac-Toe</h1>

    <div style="display: flex; width: 95vw; position: relative">
      <p id="userCont">You: <span id="user"></span></p>
      <p style="position: absolute; right: 0" id="oppNameCont">
        Opponent: <span id="oppName"></span>
      </p>
    </div>

    <p id="valueCont">You are playing as <span id="value"></span></p>
    <p id="whosTurn">X's Turn</p>

    <div id="setup">
      <p style="font-size: 1.2rem" id="enterName">Enter your name:</p>
      <input type="text" id="name" placeholder="Name" autocomplete="off" />
      <button id="find">Search for a player</button>
      <img id="loading" src="loading.gif" alt="Loading..." />
    </div>

    <div id="gameArea">
      <div id="cont">
        <button id="btn1" class="btn"></button>
        <button id="btn2" class="btn"></button>
        <button id="btn3" class="btn"></button>
        <button id="btn4" class="btn"></button>
        <button id="btn5" class="btn"></button>
        <button id="btn6" class="btn"></button>
        <button id="btn7" class="btn"></button>
        <button id="btn8" class="btn"></button>
        <button id="btn9" class="btn"></button>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>

    <script>
      const socket = io();
      let name = "";
      let playerValue = "";
      const loading = document.getElementById("loading");
      const gameArea = document.getElementById("gameArea");

      // Hide unnecessary sections initially
      const hideGameUI = () => {
        [
          "userCont",
          "oppNameCont",
          "valueCont",
          "whosTurn",
          "gameArea",
        ].forEach((id) => (document.getElementById(id).style.display = "none"));
        loading.style.display = "none";
      };
      hideGameUI();

      // Show game UI when paired
      const showGameUI = () => {
        [
          "userCont",
          "oppNameCont",
          "valueCont",
          "whosTurn",
          "gameArea",
        ].forEach((id) => (document.getElementById(id).style.display = "block"));
        document.getElementById("setup").style.display = "none";
      };

      document.getElementById("find").addEventListener("click", () => {
        name = document.getElementById("name").value.trim();
        if (!name) return alert("Please enter your name");

        document.getElementById("user").innerText = name;
        socket.emit("find", { name });
        loading.style.display = "block";
        document.getElementById("find").disabled = true;
      });

      // Match found
      socket.on("find", ({ allPlayers }) => {
        const player = allPlayers.find(
          (p) => p.p1.p1name === name || p.p2.p2name === name
        );
        if (!player) return alert("Error: Match not found.");

        const isP1 = player.p1.p1name === name;
        const opponent = isP1 ? player.p2.p2name : player.p1.p1name;
        playerValue = isP1 ? player.p1.p1value : player.p2.p2value;

        document.getElementById("oppName").innerText = opponent;
        document.getElementById("value").innerText = playerValue;
        showGameUI();
      });

      // Board click handler
      document.querySelectorAll(".btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          if (btn.innerText !== "") return;
          btn.innerText = playerValue;
          btn.disabled = true;
          socket.emit("playing", {
            value: playerValue,
            id: btn.id,
            name,
          });
        });
      });

      // Game play updates
      socket.on("playing", ({ allPlayers }) => {
        const player = allPlayers.find(
          (p) => p.p1.p1name === name || p.p2.p2name === name
        );
        if (!player) return;

        const { p1, p2, sum } = player;

        const turnText = sum % 2 === 0 ? "O's Turn" : "X's Turn";
        document.getElementById("whosTurn").innerText = turnText;

        [p1, p2].forEach((playerObj) => {
          if (playerObj.p1move)
            updateButton(playerObj.p1move, "X");
          if (playerObj.p2move)
            updateButton(playerObj.p2move, "O");
        });

        checkWinner(sum);
      });

      // Helper: update button
      const updateButton = (id, symbol) => {
        const btn = document.getElementById(id);
        if (!btn.disabled) {
          btn.innerText = symbol;
          btn.disabled = true;
        }
      };

      // Winner check
      const checkWinner = (sum) => {
        const b = [...Array(10).keys()].map(
          (i) => (document.getElementById("btn" + i)?.innerText || "")
        );

        const winCombos = [
          [1, 2, 3],
          [4, 5, 6],
          [7, 8, 9],
          [1, 4, 7],
          [2, 5, 8],
          [3, 6, 9],
          [1, 5, 9],
          [3, 5, 7],
        ];

        const winner = winCombos.find(
          ([a, b1, c]) =>
            b[a] && b[a] === b[b1] && b[a] === b[c]
        );

        if (winner) {
          socket.emit("gameOver", { name });
          setTimeout(() => {
            alert(`${b[winner[0]]} WON!!`);
            location.reload();
          }, 500);
        } else if (sum >= 10) {
          socket.emit("gameOver", { name });
          setTimeout(() => {
            alert("DRAW!!");
            location.reload();
          }, 500);
        }
      };
    </script>
  </body>
</html>
